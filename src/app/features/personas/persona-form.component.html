<div class="min-h-screen bg-slate-50/50 p-6 lg:p-8 font-sans text-slate-900">
  
  <div class="mb-8 animate-fade-in">
    <div class="flex items-center gap-3 mb-2">
      <button 
        (click)="onCancel()"
        class="p-2 hover:bg-slate-100 rounded-lg transition-colors">
        <app-icon icon="arrow_back" size="sm" class="text-slate-600"></app-icon>
      </button>
      <h1 class="text-2xl md:text-3xl font-bold text-slate-900 tracking-tight">
        {{ isEditMode() ? 'Editar ' + getTipoLabel() : 'Nuevo ' + getTipoLabel() }}
      </h1>
    </div>
    <p class="text-slate-500 text-sm md:text-base ml-12">
      {{ isEditMode() ? 'Modifica la información de la persona' : 'Completa el formulario para crear un nuevo ' + getTipoLabel().toLowerCase() }}
    </p>
  </div>

  @if (loading()) {
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8 animate-pulse">
      <div class="space-y-4">
        <div class="h-4 bg-slate-200 rounded w-3/4"></div>
        <div class="h-4 bg-slate-200 rounded w-1/2"></div>
        <div class="h-32 bg-slate-200 rounded"></div>
      </div>
    </div>
  }

  @if (!loading()) {
    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="space-y-6">
      
      <!-- Alertas -->
      @if (error()) {
        <div class="bg-red-50 border border-red-200 rounded-xl p-4 flex items-start gap-3">
          <app-icon icon="error" size="md" class="text-red-600 mt-0.5 flex-shrink-0"></app-icon>
          <div class="flex-1">
            <h3 class="text-sm font-bold text-red-800">Error de validación</h3>
            <div class="text-sm text-red-600 mt-1 whitespace-pre-line">{{ error() }}</div>
          </div>
        </div>
      }

      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 space-y-6">
        
        <!-- Nombre Completo (estudiantes, docentes, administrativos) -->
        @if (isEstudiante() || isDocente() || isAdministrativo()) {
          <div>
            <label for="nombreCompleto" class="block text-sm font-medium text-gray-700 mb-2">
              Nombre Completo <span class="text-red-500">*</span>
            </label>
            <input
              id="nombreCompleto"
              type="text"
              formControlName="nombreCompleto"
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              [class.border-red-500]="form.get('nombreCompleto')?.invalid && form.get('nombreCompleto')?.touched"
              required
            />
            @if (form.get('nombreCompleto')?.invalid && form.get('nombreCompleto')?.touched) {
              <p class="mt-1.5 text-sm text-red-600">
                @if (form.get('nombreCompleto')?.errors?.['required']) {
                  El nombre completo es requerido
                } @else if (form.get('nombreCompleto')?.errors?.['minlength']) {
                  El nombre debe tener al menos 3 caracteres
                }
              </p>
            }
          </div>
        }

        <!-- Nombre (solo responsables externos) -->
        @if (isResponsableExterno()) {
          <div>
            <label for="nombre" class="block text-sm font-medium text-gray-700 mb-2">
              Nombre <span class="text-red-500">*</span>
            </label>
            <input
              id="nombre"
              type="text"
              formControlName="nombre"
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              [class.border-red-500]="form.get('nombre')?.invalid && form.get('nombre')?.touched"
              required
            />
            @if (form.get('nombre')?.invalid && form.get('nombre')?.touched) {
              <p class="mt-1.5 text-sm text-red-600">
                @if (form.get('nombre')?.errors?.['required']) {
                  El nombre es requerido
                } @else if (form.get('nombre')?.errors?.['minlength']) {
                  El nombre debe tener al menos 3 caracteres
                }
              </p>
            }
          </div>
        }

        <!-- Número de Carnet (solo estudiantes) -->
        @if (isEstudiante()) {
          <div>
            <label for="numeroCarnet" class="block text-sm font-medium text-gray-700 mb-2">
              Carnet <span class="text-red-500">*</span>
            </label>
            <input
              id="numeroCarnet"
              type="text"
              formControlName="numeroCarnet"
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              [class.border-red-500]="form.get('numeroCarnet')?.invalid && form.get('numeroCarnet')?.touched"
              required
            />
            @if (form.get('numeroCarnet')?.invalid && form.get('numeroCarnet')?.touched) {
              <p class="mt-1.5 text-sm text-red-600">Número de carnet es requerido</p>
            }
          </div>
        }

        <!-- Cédula (estudiantes - obligatorio, docentes y administrativos - opcional) -->
        @if (isEstudiante()) {
          <div>
            <label for="cedula" class="block text-sm font-medium text-gray-700 mb-2">
              Cédula <span class="text-red-500">*</span>
            </label>
            <input
              id="cedula"
              type="text"
              formControlName="cedula"
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              [class.border-red-500]="form.get('cedula')?.invalid && form.get('cedula')?.touched"
              required
            />
            @if (form.get('cedula')?.invalid && form.get('cedula')?.touched) {
              <p class="mt-1.5 text-sm text-red-600">La cédula es requerida</p>
            }
            <p class="mt-1.5 text-sm text-slate-500">
              Número de identificación personal
            </p>
          </div>
        }
        @if (isDocente() || isAdministrativo()) {
          <div>
            <label for="cedula" class="block text-sm font-medium text-gray-700 mb-2">
              Cédula
            </label>
            <input
              id="cedula"
              type="text"
              formControlName="cedula"
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <p class="mt-1.5 text-sm text-slate-500">
              Número de identificación personal
            </p>
          </div>
        }

        <!-- Correo (estudiantes, docentes, administrativos - requerido) -->
        @if (isEstudiante() || isDocente() || isAdministrativo()) {
          <div>
            <label for="correo" class="block text-sm font-medium text-gray-700 mb-2">
              Correo Electrónico <span class="text-red-500">*</span>
            </label>
            <input
              id="correo"
              type="email"
              formControlName="correo"
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              [class.border-red-500]="form.get('correo')?.invalid && form.get('correo')?.touched"
              required
            />
            @if (form.get('correo')?.invalid && form.get('correo')?.touched) {
              <p class="mt-1.5 text-sm text-red-600">
                @if (form.get('correo')?.errors?.['required']) {
                  El correo es requerido
                } @else if (form.get('correo')?.errors?.['email']) {
                  Ingresa un correo electrónico válido
                }
              </p>
            }
          </div>
        }

        <!-- Institución (solo responsables externos - requerido) -->
        @if (isResponsableExterno()) {
          <div>
            <label for="institucion" class="block text-sm font-medium text-gray-700 mb-2">
              Institución <span class="text-red-500">*</span>
            </label>
            <input
              id="institucion"
              type="text"
              formControlName="institucion"
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              [class.border-red-500]="form.get('institucion')?.invalid && form.get('institucion')?.touched"
              required
            />
            @if (form.get('institucion')?.invalid && form.get('institucion')?.touched) {
              <p class="mt-1.5 text-sm text-red-600">
                @if (form.get('institucion')?.errors?.['required']) {
                  La institución es requerida
                } @else if (form.get('institucion')?.errors?.['minlength']) {
                  La institución debe tener al menos 3 caracteres
                }
              </p>
            }
          </div>
        }

        <!-- Género (estudiantes, docentes y administrativos) -->
        @if (isEstudiante() || isDocente() || isAdministrativo()) {
          <div>
            <label for="idGenero" class="block text-sm font-medium text-gray-700 mb-2">
              Sexo <span class="text-red-500">*</span>
            </label>
            <select
              id="idGenero"
              formControlName="idGenero"
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              [class.border-red-500]="form.get('idGenero')?.invalid && form.get('idGenero')?.touched"
              required
            >
              <option [ngValue]="null">Seleccione un sexo...</option>
              @for (genero of generos(); track genero.id) {
                <option [ngValue]="genero.id">{{ genero.codigo }}</option>
              }
            </select>
            @if (form.get('idGenero')?.invalid && form.get('idGenero')?.touched) {
              <p class="mt-1.5 text-sm text-red-600">El sexo es requerido</p>
            }
            @if (isEditMode() && form.get('idGenero')?.value) {
              @for (genero of generos(); track genero.id) {
                @if (genero.id === form.get('idGenero')?.value) {
                  <p class="mt-1.5 text-sm text-slate-500">
                    Valor actual: <span class="font-medium">{{ genero.codigo }}</span>
                  </p>
                }
              }
            }
          </div>
        }

        <!-- Estado (solo estudiantes) -->
        @if (isEstudiante()) {
          <div>
            <label for="idEstadoEstudiante" class="block text-sm font-medium text-gray-700 mb-2">
              Estado <span class="text-red-500">*</span>
            </label>
            <select
              id="idEstadoEstudiante"
              formControlName="idEstadoEstudiante"
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              [class.border-red-500]="form.get('idEstadoEstudiante')?.invalid && form.get('idEstadoEstudiante')?.touched"
              required
            >
              <option [ngValue]="null">Seleccione un estado...</option>
              @for (estado of estadosEstudiante(); track estado.id) {
                <option [ngValue]="estado.id">{{ estado.nombre }}</option>
              }
            </select>
            @if (form.get('idEstadoEstudiante')?.invalid && form.get('idEstadoEstudiante')?.touched) {
              <p class="mt-1.5 text-sm text-red-600">El estado es requerido</p>
            }
            @if (isEditMode() && form.get('idEstadoEstudiante')?.value) {
              @for (estado of estadosEstudiante(); track estado.id) {
                @if (estado.id === form.get('idEstadoEstudiante')?.value) {
                  <p class="mt-1.5 text-sm text-slate-500">
                    Valor actual: <span class="font-medium">{{ estado.nombre }}</span>
                  </p>
                }
              }
            }
          </div>
        }
        
        <!-- Departamento (solo docentes y administrativos) -->
        @if (isDocente() || isAdministrativo()) {
          <div>
            <label for="departamentoId" class="block text-sm font-medium text-gray-700 mb-2">
              Departamento <span class="text-red-500">*</span>
            </label>
            <select
              id="departamentoId"
              formControlName="departamentoId"
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              [class.border-red-500]="form.get('departamentoId')?.invalid && form.get('departamentoId')?.touched"
              required
            >
              <option [ngValue]="null">Seleccione un departamento...</option>
              @for (dept of departamentos(); track dept.id) {
                <option [ngValue]="dept.id">{{ dept.nombre }}</option>
              }
            </select>
            @if (form.get('departamentoId')?.invalid && form.get('departamentoId')?.touched) {
              <p class="mt-1.5 text-sm text-red-600">El departamento es requerido</p>
            }
          </div>
        }

        <!-- Número ORCID (estudiantes, docentes y administrativos, opcional) -->
        @if (isEstudiante() || isDocente() || isAdministrativo()) {
          <div>
            <label for="numeroOrcid" class="block text-sm font-medium text-gray-700 mb-2">
              Número ORCID
            </label>
            <input
              id="numeroOrcid"
              type="text"
              formControlName="numeroOrcid"
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <p class="mt-1.5 text-sm text-slate-500">
              Identificador único para investigadores (opcional)
            </p>
          </div>
        }

        <!-- Nivel Académico (docentes y administrativos, opcional) -->
        @if (isDocente() || isAdministrativo()) {
          <div>
            <label for="idNivelAcademico" class="block text-sm font-medium text-gray-700 mb-2">
              Nivel Académico
            </label>
            <select
              id="idNivelAcademico"
              formControlName="idNivelAcademico"
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
              <option [ngValue]="null">Seleccione un nivel académico...</option>
              @for (nivel of nivelesAcademico(); track nivel.id) {
                <option [ngValue]="nivel.id">{{ nivel.nombre }}</option>
              }
            </select>
            <p class="mt-1.5 text-sm text-slate-500">
              Nivel académico (opcional)
            </p>
          </div>
        }

        <!-- Puesto (solo administrativos, opcional) -->
        @if (isAdministrativo()) {
          <div>
            <label for="puesto" class="block text-sm font-medium text-gray-700 mb-2">
              Puesto
            </label>
            <input
              id="puesto"
              type="text"
              formControlName="puesto"
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <p class="mt-1.5 text-sm text-slate-500">
              Puesto del administrativo
            </p>
          </div>
        }

        <!-- Carrera (solo estudiantes, obligatorio) -->
        @if (isEstudiante()) {
          <div>
            <label for="idCarrera" class="block text-sm font-medium text-gray-700 mb-2">
              Carrera <span class="text-red-500">*</span>
            </label>
            <select
              id="idCarrera"
              formControlName="idCarrera"
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              [class.border-red-500]="form.get('idCarrera')?.invalid && form.get('idCarrera')?.touched"
              required
            >
              <option [ngValue]="null">Seleccione una carrera...</option>
              @for (carrera of carreras(); track carrera.idCarrera || carrera.id) {
                <option [ngValue]="carrera.idCarrera || carrera.id">
                  {{ carrera.codigo ? (carrera.codigo + ' - ') : '' }}{{ carrera.nombre }}
                </option>
              }
            </select>
            @if (form.get('idCarrera')?.invalid && form.get('idCarrera')?.touched) {
              <p class="mt-1.5 text-sm text-red-600">La carrera es requerida</p>
            }
            <p class="mt-1.5 text-sm text-slate-500">
              Seleccione la carrera del estudiante
            </p>
          </div>
        }

        <!-- Nivel Formación (solo estudiantes, opcional) -->
        @if (isEstudiante()) {
          <div>
            <label for="nivelFormacion" class="block text-sm font-medium text-gray-700 mb-2">
              Nivel Formación
            </label>
            <select
              id="nivelFormacion"
              formControlName="nivelFormacion"
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
              <option [ngValue]="null">Seleccione un nivel...</option>
              @for (nivel of nivelesFormacion; track nivel.value) {
                <option [ngValue]="nivel.value">{{ nivel.label }}</option>
              }
            </select>
            @if (isEditMode() && form.get('nivelFormacion')?.value) {
              <p class="mt-1.5 text-sm text-slate-500">
                Valor actual: <span class="font-medium">{{ form.get('nivelFormacion')?.value }}</span>
              </p>
            } @else {
              <p class="mt-1.5 text-sm text-slate-500">
                Nivel de formación académica 
              </p>
            }
          </div>
        }
        
        <!-- Número de Teléfono (estudiantes, docentes y administrativos, opcional) -->
        @if (isEstudiante() || isDocente() || isAdministrativo()) {
          <div>
            <label for="numeroTelefono" class="block text-sm font-medium text-gray-700 mb-2">
              Número de Teléfono
            </label>
            <input
              id="numeroTelefono"
              type="text"
              formControlName="numeroTelefono"
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <p class="mt-1.5 text-sm text-slate-500">
              Número de teléfono de contacto
            </p>
          </div>
        }

        <!-- Cargo (solo responsables externos, opcional) -->
        @if (isResponsableExterno()) {
          <div>
            <label for="cargo" class="block text-sm font-medium text-gray-700 mb-2">
              Cargo
            </label>
            <input
              id="cargo"
              type="text"
              formControlName="cargo"
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <p class="mt-1.5 text-sm text-slate-500">
              Cargo o puesto del responsable (opcional)
            </p>
          </div>
        }

        <!-- Teléfono (solo responsables externos, opcional) -->
        @if (isResponsableExterno()) {
          <div>
            <label for="telefono" class="block text-sm font-medium text-gray-700 mb-2">
              Teléfono
            </label>
            <input
              id="telefono"
              type="text"
              formControlName="telefono"
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
            <p class="mt-1.5 text-sm text-slate-500">
              Número de teléfono de contacto (opcional)
            </p>
          </div>
        }

        <!-- Correo (solo responsables externos, opcional) -->
        @if (isResponsableExterno()) {
          <div>
            <label for="correo" class="block text-sm font-medium text-gray-700 mb-2">
              Correo Electrónico
            </label>
            <input
              id="correo"
              type="email"
              formControlName="correo"
              class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              [class.border-red-500]="form.get('correo')?.invalid && form.get('correo')?.touched"
            />
            @if (form.get('correo')?.invalid && form.get('correo')?.touched) {
              <p class="mt-1.5 text-sm text-red-600">
                @if (form.get('correo')?.errors?.['email']) {
                  Ingresa un correo electrónico válido
                }
              </p>
            }
            <p class="mt-1.5 text-sm text-slate-500">
              Correo electrónico de contacto (opcional)
            </p>
          </div>
        }

        <!-- Activo (solo en modo edición, no para estudiantes) -->
        @if (isEditMode() && !isEstudiante()) {
          <div class="flex items-center gap-3">
            <input
              id="activo"
              type="checkbox"
              formControlName="activo"
              class="w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500"
            />
            <label for="activo" class="text-sm font-medium text-slate-700">
              Activo
            </label>
          </div>
        }

      </div>

      <!-- Botones -->
      <div class="flex items-center justify-end gap-4">
        <button
          type="button"
          (click)="onCancel()"
          class="px-6 py-2.5 border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors">
          Cancelar
        </button>
        <button
          type="submit"
          [disabled]="form.invalid || saving()"
          class="px-6 py-2.5 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2">
          @if (saving()) {
            <span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full"></span>
            <span>Guardando...</span>
          } @else {
            <span>{{ isEditMode() ? 'Actualizar' : 'Crear' }}</span>
          }
        </button>
      </div>

    </form>
  }
</div>

