<div class="min-h-screen bg-slate-50/50 p-6 lg:p-8 font-sans text-slate-900">
  
  <div class="mb-8 animate-fade-in">
    <div class="flex items-center gap-3 mb-2">
      <button 
        (click)="onCancel()"
        class="p-2 -ml-2 text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 rounded-full transition-colors">
        <app-icon icon="arrow_back" size="sm"></app-icon>
      </button>
      <h1 class="text-2xl font-bold text-slate-900 tracking-tight">
        {{ isEditMode() ? 'Editar Documento Divulgado' : 'Nuevo Documento Divulgado' }}
      </h1>
    </div>
    <p class="text-slate-500 text-sm ml-10">
      {{ isEditMode() ? 'Modifica la información del documento divulgado' : 'Completa el formulario para crear un nuevo documento divulgado' }}
    </p>
  </div>

  @if (loading()) {
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8 animate-pulse">
      <div class="space-y-4">
        <div class="h-4 bg-slate-200 rounded w-3/4"></div>
        <div class="h-4 bg-slate-200 rounded w-1/2"></div>
        <div class="h-32 bg-slate-200 rounded"></div>
      </div>
    </div>
  }

  @if (!loading()) {
    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="bg-white rounded-xl shadow-sm border border-slate-200">
      
      <!-- Alertas -->
      @if (error()) {
        <div class="p-6 pb-0">
          <div class="bg-red-50 border-2 border-red-200 rounded-xl p-4 flex items-start gap-3">
            <app-icon icon="error_outline" size="md" class="text-red-600 mt-0.5"></app-icon>
            <div>
              <h3 class="text-sm font-bold text-red-800">Error</h3>
              <p class="text-sm text-red-600 mt-1">{{ error() }}</p>
            </div>
          </div>
        </div>
      }

      <div class="p-6 md:p-8 space-y-6">
        
        <!-- Nombre del Documento -->
        <div>
          <label for="nombreDocumento" class="block text-sm font-medium text-slate-700 mb-2 flex items-center gap-2">
            <app-icon icon="title" size="xs" class="text-emerald-600"></app-icon>
            Nombre del Documento <span class="text-red-500">*</span>
          </label>
          <input
            id="nombreDocumento"
            type="text"
            formControlName="nombreDocumento"
            placeholder="Ingrese el nombre del documento"
            class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all text-sm">
          @if (form.get('nombreDocumento')?.invalid && form.get('nombreDocumento')?.touched) {
            <p class="mt-1 text-xs text-red-600">Este campo es requerido y debe tener al menos 3 caracteres</p>
          }
        </div>

        <!-- Tipo de Documento Divulgado -->
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2 flex items-center gap-2">
            <app-icon icon="category" size="xs" class="text-emerald-600"></app-icon>
            Tipo de Documento Divulgado
          </label>
          <div class="relative dropdown-tipo-documento">
            @if (getTipoDocumentoSeleccionado()) {
              <div class="flex items-center gap-2 p-3 bg-emerald-50 border-2 border-emerald-200 rounded-lg">
                <span class="flex-1 text-sm font-medium text-emerald-900">
                  {{ getTipoDocumentoSeleccionado()?.nombre }}
                </span>
                <button
                  type="button"
                  (click)="eliminarTipoDocumento(); $event.stopPropagation()"
                  class="p-1 text-emerald-600 hover:text-emerald-700 hover:bg-emerald-100 rounded transition-colors">
                  <app-icon icon="close" size="xs"></app-icon>
                </button>
              </div>
            } @else {
              <div class="relative">
                <input
                  type="text"
                  [value]="filtroTipoDocumento()"
                  (input)="filtroTipoDocumento.set($any($event.target).value)"
                  (click)="toggleDropdownTipoDocumento(); $event.stopPropagation()"
                  (focus)="mostrarDropdownTipoDocumento.set(true)"
                  placeholder="Buscar tipo de documento..."
                  class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all text-sm"
                  autocomplete="off">
                <app-icon icon="search" size="xs" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></app-icon>
              </div>
              @if (mostrarDropdownTipoDocumento()) {
                <div class="absolute z-50 w-full mt-1 bg-white border-2 border-slate-300 rounded-lg shadow-xl max-h-60 overflow-y-auto">
                  @if (filtrarTiposDocumento().length === 0) {
                    <div class="p-4 text-sm text-slate-500 text-center">No se encontraron tipos de documento</div>
                  } @else {
                    @for (tipo of filtrarTiposDocumento(); track tipo.id) {
                      <button
                        type="button"
                        (click)="seleccionarTipoDocumento(tipo); $event.stopPropagation()"
                        class="w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-emerald-50 hover:text-emerald-700 transition-colors">
                        <div class="font-medium">{{ tipo.nombre }}</div>
                        @if (tipo.descripcion) {
                          <div class="text-xs text-slate-500 mt-0.5">{{ tipo.descripcion }}</div>
                        }
                      </button>
                    }
                  }
                </div>
              }
            }
          </div>
        </div>

        <!-- Departamento -->
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-2 flex items-center gap-2">
            <app-icon icon="business" size="xs" class="text-emerald-600"></app-icon>
            Departamento
          </label>
          <div class="relative dropdown-departamento">
            @if (getDepartamentoSeleccionado()) {
              <div class="flex items-center gap-2 p-3 bg-emerald-50 border-2 border-emerald-200 rounded-lg">
                <span class="flex-1 text-sm font-medium text-emerald-900">
                  {{ getDepartamentoSeleccionado()?.nombre }}
                </span>
                <button
                  type="button"
                  (click)="eliminarDepartamento(); $event.stopPropagation()"
                  class="p-1 text-emerald-600 hover:text-emerald-700 hover:bg-emerald-100 rounded transition-colors">
                  <app-icon icon="close" size="xs"></app-icon>
                </button>
              </div>
            } @else {
              <div class="relative">
                <input
                  type="text"
                  [value]="filtroDepartamento()"
                  (input)="filtroDepartamento.set($any($event.target).value)"
                  (click)="toggleDropdownDepartamento(); $event.stopPropagation()"
                  (focus)="mostrarDropdownDepartamento.set(true)"
                  placeholder="Buscar departamento..."
                  class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all text-sm"
                  autocomplete="off">
                <app-icon icon="search" size="xs" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></app-icon>
              </div>
              @if (mostrarDropdownDepartamento()) {
                <div class="absolute z-50 w-full mt-1 bg-white border-2 border-slate-300 rounded-lg shadow-xl max-h-60 overflow-y-auto">
                  @if (filtrarDepartamentos().length === 0) {
                    <div class="p-4 text-sm text-slate-500 text-center">No se encontraron departamentos</div>
                  } @else {
                    @for (departamento of filtrarDepartamentos(); track departamento.id) {
                      <button
                        type="button"
                        (click)="seleccionarDepartamento(departamento); $event.stopPropagation()"
                        class="w-full px-4 py-2 text-left text-sm text-slate-700 hover:bg-emerald-50 hover:text-emerald-700 transition-colors">
                        <div class="font-medium">{{ departamento.nombre }}</div>
                      </button>
                    }
                  }
                </div>
              }
            }
          </div>
        </div>

        <!-- Cantidades de Participantes -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label for="cantidadEstudiantesParticipantes" class="block text-sm font-medium text-slate-700 mb-2 flex items-center gap-2">
              <app-icon icon="person" size="xs" class="text-emerald-600"></app-icon>
              Estudiantes Participantes
            </label>
            <input
              id="cantidadEstudiantesParticipantes"
              type="number"
              formControlName="cantidadEstudiantesParticipantes"
              min="0"
              class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all text-sm">
          </div>
          <div>
            <label for="cantidadDocentesParticipantes" class="block text-sm font-medium text-slate-700 mb-2 flex items-center gap-2">
              <app-icon icon="school" size="xs" class="text-emerald-600"></app-icon>
              Docentes Participantes
            </label>
            <input
              id="cantidadDocentesParticipantes"
              type="number"
              formControlName="cantidadDocentesParticipantes"
              min="0"
              class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all text-sm">
          </div>
          <div>
            <label for="cantidadAdministrativosParticipantes" class="block text-sm font-medium text-slate-700 mb-2 flex items-center gap-2">
              <app-icon icon="business" size="xs" class="text-emerald-600"></app-icon>
              Administrativos Participantes
            </label>
            <input
              id="cantidadAdministrativosParticipantes"
              type="number"
              formControlName="cantidadAdministrativosParticipantes"
              min="0"
              class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all text-sm">
          </div>
        </div>

        <!-- Participantes Divulgación Científica y Cantidad de Productos -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="participantesDivulgacionCientifica" class="block text-sm font-medium text-slate-700 mb-2 flex items-center gap-2">
              <app-icon icon="article" size="xs" class="text-emerald-600"></app-icon>
              Participantes Divulgación Científica
            </label>
            <input
              id="participantesDivulgacionCientifica"
              type="number"
              formControlName="participantesDivulgacionCientifica"
              min="0"
              class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all text-sm">
          </div>
          <div>
            <label for="cantidadProductos" class="block text-sm font-medium text-slate-700 mb-2 flex items-center gap-2">
              <app-icon icon="inventory_2" size="xs" class="text-emerald-600"></app-icon>
              Cantidad de Productos
            </label>
            <input
              id="cantidadProductos"
              type="number"
              formControlName="cantidadProductos"
              min="0"
              class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all text-sm">
          </div>
        </div>

        <!-- Link de Acceso -->
        <div>
          <label for="linkAcceso" class="block text-sm font-medium text-slate-700 mb-2 flex items-center gap-2">
            <app-icon icon="link" size="xs" class="text-emerald-600"></app-icon>
            Link de Acceso
          </label>
          <input
            id="linkAcceso"
            type="url"
            formControlName="linkAcceso"
            placeholder="https://ejemplo.com/documento"
            class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all text-sm">
        </div>

        <!-- Archivo de Respaldo -->
        <div>
          <label for="archivoRespaldo" class="block text-sm font-medium text-slate-700 mb-2 flex items-center gap-2">
            <app-icon icon="attach_file" size="xs" class="text-emerald-600"></app-icon>
            Archivo de Respaldo
          </label>
          @if (selectedFile()) {
            <div class="flex items-center gap-3 p-3 bg-emerald-50 border-2 border-emerald-200 rounded-lg">
              <div class="flex-1">
                <p class="text-sm font-medium text-emerald-900">{{ selectedFile()?.name }}</p>
                <p class="text-xs text-emerald-600 mt-0.5">{{ (selectedFile()!.size / 1024).toFixed(2) }} KB</p>
              </div>
              <button
                type="button"
                (click)="removeFile()"
                class="p-1 text-emerald-600 hover:text-emerald-700 hover:bg-emerald-100 rounded transition-colors">
                <app-icon icon="close" size="xs"></app-icon>
              </button>
            </div>
            @if (filePreviewUrl()) {
              <div class="mt-3">
                <img [src]="filePreviewUrl()!" alt="Preview" class="max-w-xs rounded-lg border border-slate-200">
              </div>
            }
          } @else {
            <div class="relative">
              <input
                id="archivoRespaldo"
                type="file"
                (change)="onFileSelected($event)"
                accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 transition-all text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100">
            </div>
          }
        </div>

      </div>

      <!-- Botones de acción -->
      <div class="p-6 md:p-8 border-t border-slate-200 flex flex-col sm:flex-row gap-3 justify-end">
        <button
          type="button"
          (click)="onCancel()"
          class="px-6 py-2.5 border-2 border-slate-300 text-slate-700 font-medium rounded-lg hover:bg-slate-50 transition-colors">
          Cancelar
        </button>
        <button
          type="submit"
          [disabled]="saving() || form.invalid"
          class="px-6 py-2.5 bg-emerald-600 text-white font-medium rounded-lg hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2">
          @if (saving()) {
            <span class="animate-spin">⏳</span>
          } @else {
            <app-icon icon="check" size="xs" color="white"></app-icon>
          }
          {{ isEditMode() ? 'Actualizar' : 'Crear' }} Documento
        </button>
      </div>

    </form>
  }

</div>

